"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[5342],{3905:function(e,t,a){a.d(t,{Zo:function(){return u},kt:function(){return d}});var n=a(7294);function o(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function i(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function r(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?i(Object(a),!0).forEach((function(t){o(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):i(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,o=function(e,t){if(null==e)return{};var a,n,o={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(o[a]=e[a]);return o}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(o[a]=e[a])}return o}var s=n.createContext({}),c=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):r(r({},t),e)),a},u=function(e){var t=c(e.components);return n.createElement(s.Provider,{value:t},e.children)},p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,o=e.mdxType,i=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),m=c(a),d=o,h=m["".concat(s,".").concat(d)]||m[d]||p[d]||i;return a?n.createElement(h,r(r({ref:t},u),{},{components:a})):n.createElement(h,r({ref:t},u))}));function d(e,t){var a=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var i=a.length,r=new Array(i);r[0]=m;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:o,r[1]=l;for(var c=2;c<i;c++)r[c]=a[c];return n.createElement.apply(null,r)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},3734:function(e,t,a){a.r(t),a.d(t,{frontMatter:function(){return l},contentTitle:function(){return s},metadata:function(){return c},assets:function(){return u},toc:function(){return p},default:function(){return d}});var n=a(7462),o=a(3366),i=(a(7294),a(3905)),r=["components"],l={slug:"ADR - SQL Framework",title:"Use sqlboiler together with build tags to support multiple databases",authors:[{name:"Florian Braun",title:"go-cf-api Team",url:"https://github.com/FloThinksPi",image_url:"https://avatars1.githubusercontent.com/u/5863788?v=4"},{name:"Marc Misoch",title:"go-cf-api Team",url:"https://github.com/MMisoch",image_url:"https://avatars1.githubusercontent.com/u/47423110?v=4"},{name:"Andrew Paine",title:"go-cf-api Team",url:"https://github.com/andy-paine",image_url:"https://avatars1.githubusercontent.com/u/14118619?v=4"}],tags:["adr"]},s="Use [sqlboiler](https://github.com/volatiletech/sqlboiler) together with build tags to support multiple databases",c={permalink:"/go-cf-api/adrs/ADR - SQL Framework",editUrl:"https://github.com/cloudfoundry/go-cf-api/edit/main/docs/adrs/2021-07-28-use-sql-boiler-and-build-tags.md",source:"@site/adrs/2021-07-28-use-sql-boiler-and-build-tags.md",title:"Use sqlboiler together with build tags to support multiple databases",description:"* Status: accepted",date:"2021-07-28T00:00:00.000Z",formattedDate:"July 28, 2021",tags:[{label:"adr",permalink:"/go-cf-api/adrs/tags/adr"}],readingTime:2.53,truncated:!1,authors:[{name:"Florian Braun",title:"go-cf-api Team",url:"https://github.com/FloThinksPi",image_url:"https://avatars1.githubusercontent.com/u/5863788?v=4",imageURL:"https://avatars1.githubusercontent.com/u/5863788?v=4"},{name:"Marc Misoch",title:"go-cf-api Team",url:"https://github.com/MMisoch",image_url:"https://avatars1.githubusercontent.com/u/47423110?v=4",imageURL:"https://avatars1.githubusercontent.com/u/47423110?v=4"},{name:"Andrew Paine",title:"go-cf-api Team",url:"https://github.com/andy-paine",image_url:"https://avatars1.githubusercontent.com/u/14118619?v=4",imageURL:"https://avatars1.githubusercontent.com/u/14118619?v=4"}],prevItem:{title:"Use Zap logging as a performant and customizable structured logging framework",permalink:"/go-cf-api/adrs/ADR - Logging Framework"},nextItem:{title:"Use Markdown Architectural Decision Records",permalink:"/go-cf-api/adrs/ADR - ADR Format"}},u={authorsImageUrls:[void 0,void 0,void 0]},p=[{value:"Context and Problem Statement",id:"context-and-problem-statement",children:[]},{value:"Decision Drivers",id:"decision-drivers",children:[]},{value:"Considered Options",id:"considered-options",children:[]},{value:"Decision Outcome",id:"decision-outcome",children:[{value:"Positive Consequences",id:"positive-consequences",children:[]},{value:"Negative Consequences",id:"negative-consequences",children:[]}]},{value:"Pros and Cons of other options",id:"pros-and-cons-of-other-options",children:[{value:"Option 1 (sqlboiler with separate packages for Postgres and MySQL)",id:"option-1-sqlboiler-with-separate-packages-for-postgres-and-mysql",children:[]},{value:"Option 2 (sqlboiler with an extracted interface that is implemented by both Postgres and MySQL)",id:"option-2-sqlboiler-with-an-extracted-interface-that-is-implemented-by-both-postgres-and-mysql",children:[]},{value:"Option 4 GORM",id:"option-4-gorm",children:[]},{value:"Option 5 xo/xo",id:"option-5-xoxo",children:[]}]}],m={toc:p};function d(e){var t=e.components,a=(0,o.Z)(e,r);return(0,i.kt)("wrapper",(0,n.Z)({},m,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Status: accepted"),(0,i.kt)("li",{parentName:"ul"},"Deciders: ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/FloThinksPi"},"Florian Braun"),", ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/andy-paine"},"Andy Paine"),", ",(0,i.kt)("a",{parentName:"li",href:"https://github.com/mmisoch"},"Marc Misoch")),(0,i.kt)("li",{parentName:"ul"},"Date: 2021-07-28")),(0,i.kt)("h2",{id:"context-and-problem-statement"},"Context and Problem Statement"),(0,i.kt)("p",null,"The existing Cloud Controller supports both Postgres and MySQL as a storage backend and both options are used in real production deployments today.\nIn order to replace the existing Cloud Controller implementation, this project should also be able to support both"),(0,i.kt)("h2",{id:"decision-drivers"},"Decision Drivers"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Community support: should be able to work with any CC DB"),(0,i.kt)("li",{parentName:"ul"},"Performance: want a minimal runtime overhead"),(0,i.kt)("li",{parentName:"ul"},"Performance: want control over SQL queries used to be able to optimise")),(0,i.kt)("h2",{id:"considered-options"},"Considered Options"),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," with separate packages for Postgres and MySQL"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," with an extracted interface that is implemented by both Postgres and MySQL"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," in a shared package with different build tags for each implementation"),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://gorm.io/index.html"},"GORM")),(0,i.kt)("li",{parentName:"ol"},(0,i.kt)("a",{parentName:"li",href:"https://github.com/xo/xo"},"xo/xo"))),(0,i.kt)("h2",{id:"decision-outcome"},"Decision Outcome"),(0,i.kt)("p",null,"Chosen option: 3 (",(0,i.kt)("a",{parentName:"p",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," in a shared package with different build tags for each implementation) because this allows all of the model code to be generated from an existing schema and lets the compiler type check that the generated implementations have the same signatures without needing to manipulate the generated code much."),(0,i.kt)("h3",{id:"positive-consequences"},"Positive Consequences"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Model code can be regularly regenerated when CC DB schema changes (due to new migrations in existing implementation)"),(0,i.kt)("li",{parentName:"ul"},"Smaller binaries as each only contains code relevant to that DB backend"),(0,i.kt)("li",{parentName:"ul"},"Compile time checks that the generated code has the same function signatures for both implementations (or at least for all functions that are actually used)"),(0,i.kt)("li",{parentName:"ul"},"Generated code can be easily extended to support optimisations")),(0,i.kt)("h3",{id:"negative-consequences"},"Negative Consequences"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Extra tooling is required to rename and combine the files into a single package and add build tags"),(0,i.kt)("li",{parentName:"ul"},"Directory containing generated files is extremely large"),(0,i.kt)("li",{parentName:"ul"},"Developers need to supply build tags in order to browse, lint, compile and test code")),(0,i.kt)("h2",{id:"pros-and-cons-of-other-options"},"Pros and Cons of other options"),(0,i.kt)("h3",{id:"option-1-sqlboiler-with-separate-packages-for-postgres-and-mysql"},"Option 1 (",(0,i.kt)("a",{parentName:"h3",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," with separate packages for Postgres and MySQL)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Good, because ",(0,i.kt)("inlineCode",{parentName:"li"},"sqlboiler")," can be run to generate the code without modification"),(0,i.kt)("li",{parentName:"ul"},"Bad, because all controller code would need to do an ",(0,i.kt)("inlineCode",{parentName:"li"},"if"),"/",(0,i.kt)("inlineCode",{parentName:"li"},"switch")," statement on database type"),(0,i.kt)("li",{parentName:"ul"},"Bad, because binaries will contain redundant code for other databases")),(0,i.kt)("h3",{id:"option-2-sqlboiler-with-an-extracted-interface-that-is-implemented-by-both-postgres-and-mysql"},"Option 2 (",(0,i.kt)("a",{parentName:"h3",href:"https://github.com/volatiletech/sqlboiler"},"sqlboiler")," with an extracted interface that is implemented by both Postgres and MySQL)"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Good, because the interface could abstract between the two database"),(0,i.kt)("li",{parentName:"ul"},"Good, because compiler would check that both generated implementations satisfy interface"),(0,i.kt)("li",{parentName:"ul"},"Bad, because requires significant effort to extract complex ",(0,i.kt)("inlineCode",{parentName:"li"},"sqlboiler")," interfaces"),(0,i.kt)("li",{parentName:"ul"},"Bad, because some functions are static and cannot be extracted into an interface")),(0,i.kt)("h3",{id:"option-4-gorm"},"Option 4 ",(0,i.kt)("a",{parentName:"h3",href:"https://gorm.io/index.html"},"GORM")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Good, because good documentation"),(0,i.kt)("li",{parentName:"ul"},"Good, because controller code that interacts with database models is easy to write"),(0,i.kt)("li",{parentName:"ul"},"Bad, because little/no support for generating models from existing schema"),(0,i.kt)("li",{parentName:"ul"},"Bad, because has runtime overhead of using reflection")),(0,i.kt)("h3",{id:"option-5-xoxo"},"Option 5 ",(0,i.kt)("a",{parentName:"h3",href:"https://github.com/xo/xo"},"xo/xo")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Good, because generated models are extremely simple"),(0,i.kt)("li",{parentName:"ul"},"Good, because templates are easy to customise"),(0,i.kt)("li",{parentName:"ul"},"Bad, because generated models have no support for eager loading")))}d.isMDXComponent=!0}}]);