<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#375EAB">
<title>'CloudGontroller'</title>
<link type="text/css" rel="stylesheet" href="lib/style.css">
</head>
<body>

<div id="lowframe" style="position: fixed; bottom: 0; left: 0; height: 0; width: 100%; border-top: thin solid grey; background-color: white; overflow: auto;">
...
</div><!-- #lowframe -->

<div id="topbar" class="wide"><div class="container">
<div class="top-heading" id="heading-wide"><a href="">'CloudGontroller'</a></div>
<div class="top-heading" id="heading-narrow"><a href="">'CloudGontroller'</a></div>
<!--<a href="#" id="menu-button"><span id="menu-button-arrow">&#9661;</span></a>-->
<div id="menu">
<a href="" style="margin-right: 10px;">Package Index</a>
</div>
</div></div>
<div id="page" class="wide">
<div class="container">
<p><img src="https://github.tools.sap/cloudfoundry/cloudgontroller/workflows/Run%20unit%20tests/badge.svg" alt="unit tests"> <img src="https://github.tools.sap/cloudfoundry/cloudgontroller/workflows/Run%20database%20tests/badge.svg" alt="db tests"> <img src="https://github.tools.sap/cloudfoundry/cloudgontroller/workflows/Build%20binaries/badge.svg" alt="build"></p>
<h1>cloudgontroller</h1>
<p>A replacement for <a href="https://github.com/cloudfoundry/cloud_controller_ng">cloud_controller_ng</a>, written in Go</p>
<h2>Prerequisites</h2>
<ul>
<li><a href="https://golang.org/dl">Go</a> version 1.16
<pre><code class="language-bash">// Use Go version manager (GVM) or
brew install go@1.16
</code></pre>
<pre><code></code></pre>
</li>
<li>Mysql and Postgres CLI Tools (mysql, mysqldump, psql, pgdump etc.)
<pre><code class="language-bash">brew install mysql postgres
</code></pre>
<pre><code></code></pre>
</li>
<li><a href="https://github.com/magefile/mage">Mage</a> (Makefile alternative in go)
<pre><code class="language-bash">go install github.com/magefile/mage
</code></pre>
<pre><code></code></pre>
</li>
<li>Other command line tools:
<pre><code class="language-bash">mage install
</code></pre>
<pre><code>
</code></pre>
</li>
</ul>
<h2>Prepare dev database</h2>
<p>To run cloudgontroller we need a proper Cloud Controller database.
To do this we have a docker-compose file to create the DBs and SQL dumps from an existing Cloud Controller that can be used to build an DB for testing.
There are <code>mage</code> commands for most database operations.</p>
<p>Run <code>mage -l</code> to see the full list of available commands.</p>
<h3>Postgres</h3>
<pre><code class="language-bash">mage DBStart config_psql.yaml
mage DBCreate config_psql.yaml
mage DBLoad config_psql.yaml database_dumps/3.102.0_psql_ccdb.sql
</code></pre>
<h3>MySQL/MariaDB</h3>
<pre><code class="language-bash">mage DBStart config_mysql.yaml
mage DBCreate config_mysql.yaml
mage DBLoad config_mysql.yaml database_dumps/3.102.0_mysql_ccdb.sql
</code></pre>
<h3>Misc database operations</h3>
<ul>
<li>Drop database
<pre><code class="language-bash">mage DBDelete config_psql.yaml
</code></pre>
<pre><code></code></pre>
</li>
<li>Drop and recreate (empty) database
<pre><code class="language-bash">mage DBRecreate config_psql.yaml
</code></pre>
<pre><code>

</code></pre>
</li>
</ul>
<h2>Running commands</h2>
<p>Different database code and types of test are conditionally compiled and run based on <a href="https://pkg.go.dev/cmd/go#hdr-Build_constraints">Go build tags</a>.
To target a specific database and/or test set, use:</p>
<pre><code>go -tags=psql,unit &lt;go command&gt;
</code></pre>
<p>To avoid having to type out tags every time, you can instead:</p>
<pre><code>export GOFLAGS=&quot;-tags=psql,unit&quot;
</code></pre>
<p>This will make <code>go test ./...</code> just run the unit tests and also allow you to just run <code>go run cmd/main.go config_psql.yaml</code></p>
<h2>Starting the Cloud Controller</h2>
<ul>
<li>Postgres
<pre><code class="language-bash">go run --tags=psql cmd/main.go config_psql.yaml
</code></pre>
<pre><code></code></pre>
</li>
<li>MySQL/MariaDB
<pre><code class="language-bash">go run --tags=mysql cmd/main.go config_mysql.yaml
</code></pre>
<pre><code>
</code></pre>
</li>
</ul>
<p>The default values in the <code>config_{db}.yml</code> and <code>sqlboiler_{db}.toml</code> files should match the credentials for each database in <code>docker-compose-dev.yaml</code>.</p>
<p>The API should be accessible at e.g.</p>
<pre><code>http://localhost:8080/v3/buildpacks
</code></pre>
<h2>SQL Boiler</h2>
<p>To support different databases (Postgres and MySQL/MariaDB), we generate two sets of database models with <code>sqlboiler</code>. These are then included in the same package and given build tags to control when to compile each model set into the binary. Two binaries are then produced - one for each database. Attempting to use e.g. the <code>mysql</code> binary on a Postgres database will result in a startup error.</p>
<p>To facilitate the generating, combining and build tagging of the <code>sqlboiler</code> models, there is a mage task to automate it:</p>
<pre><code class="language-bash">mage GenerateSQLBoiler
</code></pre>
<p>The two binaries can then be compiled for your current OS/architecture with:</p>
<pre><code class="language-bash">mage build
</code></pre>
<p>The binaries can be compiled for other architectures by exporting the <code>GOOS</code> and <code>GOARCH</code> environment variables.</p>
<h2>Documentation</h2>
<p>Documentation is auto generated using <code>godoc</code> and <code>godoc-static</code> and served via GitHub pages. The binaries compiled by the <code>mage build</code> command will also serve the documentation at:</p>
<pre><code>http://localhost:8080/docs/v3
</code></pre>
<h2>Running tests</h2>
<p>Different tags are used to control which tests are run:</p>
<ul>
<li>Unit tests
<pre><code class="language-bash">go test -tags=&quot;unit,psql&quot; ./...
</code></pre>
<pre><code></code></pre>
</li>
<li>DB tests (Postgres) - require running database
<pre><code class="language-bash">go test -tags=&quot;db,psql&quot; ./internal/app/cloudgontroller/sqlboiler -test.config sqlboiler_psql.toml
</code></pre>
<pre><code></code></pre>
</li>
<li>DB tests (MySQL/MariaDB) - require running database
<pre><code class="language-bash">go test -tags=&quot;db,mysql&quot; ./internal/app/cloudgontroller/sqlboiler -test.config sqlboiler_mysql.toml
</code></pre>
<pre><code>
</code></pre>
</li>
</ul>
<h1>Current Feature List</h1>
<ul>
<li>Structured Logging</li>
<li>Prometheus Endpoint Metrics</li>
<li>Operations Console (REPL)</li>
<li>DBs (Postgres, MySQL) Autogenerates Go Code</li>
<li>DB Migrations</li>
<li>Read Config</li>
<li>Webserver</li>
<li>Auto API Docs</li>
<li>Godocs Auto Gen</li>
<li>Assets in memory</li>
<li>Rate Limiting</li>
</ul>
<h1>PoC ToDos</h1>
<p><a href="https://jtrack.wdf.sap.corp/browse/CFP-1731?jql=project%20%3D%20CFP%20AND%20labels%20%3D%20CCPoC">https://jtrack.wdf.sap.corp/browse/CFP-1731?jql=project%20%3D%20CFP%20AND%20labels%20%3D%20CCPoC</a></p>
<h1>MVP ToDos</h1>
<p><a href="https://jtrack.wdf.sap.corp/browse/CFP-1731?jql=project%20%3D%20CFP%20AND%20labels%20%3D%20CCMvP">https://jtrack.wdf.sap.corp/browse/CFP-1731?jql=project%20%3D%20CFP%20AND%20labels%20%3D%20CCMvP</a></p>

<h1>
	Packages
</h1>
<div class="pkg-dir">
	<table>
		<tr>
			<th class="pkg-name">Name</th>
			<th class="pkg-synopsis">Synopsis</th>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 0px;">github.tools.sap</td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 20px;">cloudfoundry</td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 40px;"><a href="github.tools.sap/cloudfoundry/cloudgontroller">cloudgontroller</a></td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 60px;"><a href="github.tools.sap/cloudfoundry/cloudgontroller/cmd">cmd</a></td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

	</table>
</div>
<div id="footer"><a href="docs.zip">Download docs.zip</a> to browse offline - Generated by <a href="https://godoc.org/golang.org/x/tools/godoc" target="_blank">godoc</a> + <a href="https://gitlab.com/tslocum/godoc-static" target="_blank">godoc-static</a></div>
</div>
</div>
</body>
</html>
