<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#375EAB">
<title>'CloudGontroller'</title>
<link type="text/css" rel="stylesheet" href="lib/style.css">
</head>
<body>

<div id="lowframe" style="position: fixed; bottom: 0; left: 0; height: 0; width: 100%; border-top: thin solid grey; background-color: white; overflow: auto;">
...
</div><!-- #lowframe -->

<div id="topbar" class="wide"><div class="container">
<div class="top-heading" id="heading-wide"><a href="">'CloudGontroller'</a></div>
<div class="top-heading" id="heading-narrow"><a href="">'CloudGontroller'</a></div>
<!--<a href="#" id="menu-button"><span id="menu-button-arrow">&#9661;</span></a>-->
<div id="menu">
<a href="" style="margin-right: 10px;">Package Index</a>
</div>
</div></div>
<div id="page" class="wide">
<div class="container">
<h1>cloudgontroller Webserver</h1>
<h2>Prerequisits</h2>
<ul>
<li>Go 1.16 minimum: <a href="https://golang.org/dl/,">https://golang.org/dl/,</a> can either be installed with GVM(Go version Manager) or via <code>brew install go</code></li>
<li>Mage (Makefile alternative in go): <a href="https://github.com/magefile/mage,">https://github.com/magefile/mage,</a> can be installed with <code>brew install mage</code></li>
<li>Mysql and Postgres CLI Tools (mysql, mysqldump, psql, pgdump etc..), can be installed with <code>brew install mysql postgres</code></li>
</ul>
<p>Install the rest of the used CLI Dependencies in this project</p>
<pre><code class="language-bash">mage InstallDeps
</code></pre>
<p>All compile time dependencies will be downloaded when compiling (If you use the mage commands)</p>
<h2>Preparing Dev Database</h2>
<p>To run cloudgontroller we need a propper ccdb.
To do this we have a docker-compose file to create the DBs and sql dumps from a ccdb that one can execute to create a ccdb.</p>
<pre><code class="language-bash">// Start Databases (Mariadb + Postgres)
docker compose -f docker-compose-dev.yaml up -d
// Create Database (Just implemented for Postgres Currently)
// It is ok if psql cli reports insert errors (table already exists)
mage DBCreate config_psql.yaml
mage DBLoad config_psql.yaml database_dumps/3.102.0_psql_ccdb.sql
// For Mariadb use this
mage DBCreate config_mysql.yaml
mage DBLoad config_mysql.yaml database_dumps/3.102.0_mysql_ccdb.sql
</code></pre>
<p>Other noteable operations on the db are</p>
<pre><code class="language-bash">// Drop DB
mage DBDelete config_mysql.yaml
// Drop and Recreate DB (will be empty)
mage DBRecreate config_mysql.yaml
</code></pre>
<h2>Starting It</h2>
<p>Simply</p>
<pre><code class="language-bash">// Make a binary to use against a mysql instance
go run --tags=psql cmd/main.go config_psql.yaml
// Make a binary to use against a postgres instance
go run --tags=mysql cmd/main.go config_psql.yaml
</code></pre>
<p>The values out of the <code>config_*.yml</code> files as well as <code>sqlboiler_*.toml</code> match the credentials in <code>docker-compose-dev.yaml</code>.
So as long as you use that docker compose file all credentials match and you dont need to mess around with the configs.</p>
<p>The method how we use sqlboiler for both technology stacks(psql and mysql) leads us to a problem which generated model to use.
We solved this by including build flags to include certain code on build time e.g. include psql code and exclude mysql code.
This will then produce two binaries, one for each db. Running on a psql config with a mysql binarie will result in a startup error.</p>
<p>There is also a mage command which outputs both binary files.
It will also run every code/doc/apidoc generator we have beforehand and then use
go build to produce a binary in the <code>build</code> folder.</p>
<pre><code class="language-bash">mage build
</code></pre>
<p>Once Running Access it e.g. with:</p>
<p>http://localhost:8080/api/v3/buildpacks</p>
<p>http://localhost:8080/docs/v3</p>
<h1>Running Tests</h1>
<p>Simply</p>
<pre><code class="language-bash">// Run all unittests
go test --tags=&quot;psql&quot; ./...
// Run all integration tests (But not DB tests)
go test --tags=&quot;integration psql&quot; ./...
// Run Integration Tests for Postgres
go test --tags=&quot;mysql_integration mysql&quot; ./internal/app/cloudgontroller/sqlboiler -test.config $PWD/sqlboiler_mysql.toml
// Run Integration Tests for Postgres
go test --tags=&quot;psql_integration psql&quot; ./internal/app/cloudgontroller/sqlboilero -test.config $PWD/sqlboiler_psql.toml
</code></pre>
<h1>Existing Features</h1>
<ul>
<li>Structured Logging</li>
<li>Prometheus Endpoint Metrics</li>
<li>Operations Console (REPL)</li>
<li>DBs (Postgres, MySQL) Autogenerates Go Code</li>
<li>DB Migrations</li>
<li>Read Config</li>
<li>Webserver</li>
<li>Auto API Docs</li>
<li>Godocs Auto Gen</li>
<li>Assets in memory</li>
<li>Rate Limiting</li>
</ul>
<h1>Needed for POC Demonstration</h1>
<p>Local Dev Demo</p>
<ul>
<li>Get Public Keys from UAA</li>
<li>Authentication (JWT)</li>
<li>Rollen</li>
<li>VCAP-REQUEST_ID middleware</li>
<li>Metric Middleware</li>
<li>Logging Redact Secrets (From SQL,Echo)</li>
<li>Tests</li>
<li>GoDocs</li>
<li>Swagger Docs</li>
</ul>
<p>For Deployment</p>
<ul>
<li>Health Endpoint</li>
<li>Extra Bosh Release
<ul>
<li>Gorouter Routing Adaptions</li>
<li>CC Config</li>
<li>Promscraper</li>
</ul>
</li>
</ul>
<h1>MVP</h1>
<ul>
<li>
<p>Cloud Gontroller</p>
<ul>
<li>Implement two simple GET endpoints (accessible for all roles): GET /v3/buildpacks/:guid + GET /v3/buildpacks (incl. query parameters, e.g. page, per_page)</li>
<li>Handle authentication (no roles)</li>
<li>Add VCAP-Request-ID header</li>
<li>Adhere to rate limits (authenticated + unauthenticated)</li>
<li>Write logs (should show up in Kibana)</li>
<li>Emit metrics (should show up in Grafana)</li>
<li>100% test coverage, well-formatted code, no (severe) linting issues</li>
</ul>
</li>
<li>
<p>Product integration</p>
<ul>
<li>Create a BOSH release (Cloud Gontroller as submodule, incl. route-registrar)</li>
<li>Add release to cf component</li>
<li>Enable deployment via config option (+ scaling options)</li>
<li>Routing done by Gorouter (list of supported endpoints as config option)</li>
</ul>
</li>
</ul>

<h1>
	Packages
</h1>
<div class="pkg-dir">
	<table>
		<tr>
			<th class="pkg-name">Name</th>
			<th class="pkg-synopsis">Synopsis</th>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 0px;">github.tools.sap</td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 20px;">cloudfoundry</td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 40px;"><a href="github.tools.sap/cloudfoundry/cloudgontroller">cloudgontroller</a></td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

		<tr>
			<td class="pkg-name" style="padding-left: 60px;"><a href="github.tools.sap/cloudfoundry/cloudgontroller/cmd">cmd</a></td>
			<td class="pkg-synopsis">
				
			</td>
		</tr>

	</table>
</div>
<div id="footer"><a href="docs.zip">Download docs.zip</a> to browse offline - Generated by <a href="https://godoc.org/golang.org/x/tools/godoc" target="_blank">godoc</a> + <a href="https://gitlab.com/tslocum/godoc-static" target="_blank">godoc-static</a></div>
</div>
</div>
</body>
</html>
