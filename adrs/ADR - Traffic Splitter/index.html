<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<link rel="alternate" type="application/rss+xml" href="/go-cf-api/adrs/rss.xml" title="go-cf-api Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/go-cf-api/adrs/atom.xml" title="go-cf-api Blog Atom Feed"><title data-react-helmet="true">Deploy haproxy to route specific endpoints/methods to the new implementation | go-cf-api</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://pages.github.com//go-cf-api/adrs/ADR - Traffic Splitter"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Deploy haproxy to route specific endpoints/methods to the new implementation | go-cf-api"><meta data-react-helmet="true" name="description" content="* Status: accepted"><meta data-react-helmet="true" property="og:description" content="* Status: accepted"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2021-08-13T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/andy-paine,https://github.com/svkrieger,https://github.com/philippthun"><meta data-react-helmet="true" property="article:tag" content="adr"><link data-react-helmet="true" rel="shortcut icon" href="/go-cf-api/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pages.github.com//go-cf-api/adrs/ADR - Traffic Splitter"><link data-react-helmet="true" rel="alternate" href="https://pages.github.com//go-cf-api/adrs/ADR - Traffic Splitter" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pages.github.com//go-cf-api/adrs/ADR - Traffic Splitter" hreflang="x-default"><link rel="stylesheet" href="/go-cf-api/assets/css/styles.7fb0ff1f.css">
<link rel="preload" href="/go-cf-api/assets/js/runtime~main.40aa757c.js" as="script">
<link rel="preload" href="/go-cf-api/assets/js/main.96fbdae1.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/go-cf-api/"><img src="/go-cf-api/img/logo.svg" alt="Documentation of the go-cf-api Project" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/go-cf-api/img/logo.svg" alt="Documentation of the go-cf-api Project" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><b class="navbar__title">go-cf-api</b></a><a class="navbar__item navbar__link" href="/go-cf-api/docs/intro">Documentation</a><a class="navbar__item navbar__link" href="/go-cf-api/godocs/intro">GoDocs</a><a class="navbar__item navbar__link" href="/go-cf-api/api">API Docs</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/go-cf-api/adrs">Architectural Decision Records</a></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a class="navbar__link" href="/go-cf-api/godocs/intro">Latest</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/go-cf-api/godocs/intro">Latest</a></li><li><a class="dropdown__link" href="/go-cf-api/versions">All versions</a></li></ul></div><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" class="navbar__link"><span><svg viewBox="0 0 20 20" width="20" height="20" aria-hidden="true" class="iconLanguage_3vod"><path fill="currentColor" d="M19.753 10.909c-.624-1.707-2.366-2.726-4.661-2.726-.09 0-.176.002-.262.006l-.016-2.063 3.525-.607c.115-.019.133-.119.109-.231-.023-.111-.167-.883-.188-.976-.027-.131-.102-.127-.207-.109-.104.018-3.25.461-3.25.461l-.013-2.078c-.001-.125-.069-.158-.194-.156l-1.025.016c-.105.002-.164.049-.162.148l.033 2.307s-3.061.527-3.144.543c-.084.014-.17.053-.151.143.019.09.19 1.094.208 1.172.018.08.072.129.188.107l2.924-.504.035 2.018c-1.077.281-1.801.824-2.256 1.303-.768.807-1.207 1.887-1.207 2.963 0 1.586.971 2.529 2.328 2.695 3.162.387 5.119-3.06 5.769-4.715 1.097 1.506.256 4.354-2.094 5.98-.043.029-.098.129-.033.207l.619.756c.08.096.206.059.256.023 2.51-1.73 3.661-4.515 2.869-6.683zm-7.386 3.188c-.966-.121-.944-.914-.944-1.453 0-.773.327-1.58.876-2.156a3.21 3.21 0 011.229-.799l.082 4.277a2.773 2.773 0 01-1.243.131zm2.427-.553l.046-4.109c.084-.004.166-.01.252-.01.773 0 1.494.145 1.885.361.391.217-1.023 2.713-2.183 3.758zm-8.95-7.668a.196.196 0 00-.196-.145h-1.95a.194.194 0 00-.194.144L.008 16.916c-.017.051-.011.076.062.076h1.733c.075 0 .099-.023.114-.072l1.008-3.318h3.496l1.008 3.318c.016.049.039.072.113.072h1.734c.072 0 .078-.025.062-.076-.014-.05-3.083-9.741-3.494-11.04zm-2.618 6.318l1.447-5.25 1.447 5.25H3.226z"></path></svg><span>English</span></span></a><ul class="dropdown__menu"><li><a href="/go-cf-api/adrs/ADR - Traffic Splitter" target="_self" rel="noopener noreferrer" class="dropdown__link dropdown__link--active" style="text-transform:capitalize">English</a></li><li><a class="dropdown__link" href="/go-cf-api/help-us-translate">Help us translate</a></li></ul></div><a href="https://github.com/cloudfoundry/go-cf-api" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="react-toggle toggle_3Zt9 react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_71bT">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_71bT">ðŸŒž</span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_2ahu thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_2hhb margin-bottom--md">All our posts</div><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/go-cf-api/adrs/ADR - Documentation Framework">Use Docusaurus to document our project</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/go-cf-api/adrs/ADR - Prometheus Framework">Use client_golang prometheus library to expose metrics</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/go-cf-api/adrs/ADR - Traffic Splitter">Deploy haproxy to route specific endpoints/methods to the new implementation</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/go-cf-api/adrs/ADR - Logging Framework">Use Zap logging as a performant and customizable structured logging framework</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/go-cf-api/adrs/ADR - SQL Framework">Use sqlboiler together with build tags to support multiple databases</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_GeHD" itemprop="headline">Deploy haproxy to route specific endpoints/methods to the new implementation</h1><div class="blogPostData_291c margin-vert--md"><time datetime="2021-08-13T00:00:00.000Z" itemprop="datePublished">August 13, 2021</time> Â· 3 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/andy-paine" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://avatars1.githubusercontent.com/u/14118619?v=4" alt="Andrew Paine"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/andy-paine" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Andrew Paine</span></a></div><small class="avatar__subtitle" itemprop="description">go-cf-api Team</small></div></div></div><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/svkrieger" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://avatars1.githubusercontent.com/u/37476281?v=4" alt="Sven Krieger"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/svkrieger" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Sven Krieger</span></a></div><small class="avatar__subtitle" itemprop="description">go-cf-api Team</small></div></div></div><div class="col col--6 authorCol_1R69"><div class="avatar margin-bottom--sm"><a href="https://github.com/philippthun" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_1yU8" src="https://avatars1.githubusercontent.com/u/618301?v=4" alt="Philipp Thun"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/philippthun" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Philipp Thun</span></a></div><small class="avatar__subtitle" itemprop="description">go-cf-api Team</small></div></div></div></div></header><div class="markdown" itemprop="articleBody"><ul><li>Status: accepted</li><li>Deciders: <a href="https://github.com/andy-paine" target="_blank" rel="noopener noreferrer">Andy Paine</a>, <a href="https://github.com/svkrieger" target="_blank" rel="noopener noreferrer">Sven Krieger</a>, <a href="https://github.com/philippthun" target="_blank" rel="noopener noreferrer">Philipp Thun</a></li><li>Date: 2021-08-04</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="context-and-problem-statement"></a>Context and Problem Statement<a class="hash-link" href="#context-and-problem-statement" title="Direct link to heading">#</a></h2><p>The existing Cloud Controller is the reference implementation of the CF v3 API.
This project should avoid replacing the entire <code>cloud_controller_ng</code> project in a single &quot;big bang&quot; migration.
In order to build the new implementation iteratively, this project should be deployable in parallel with the existing implementation.
It should be possible to route individual API calls to the new Cloud Controller as soon as each endpoint is complete.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="decision-drivers--optional"></a>Decision Drivers <a class="hash-link" href="#decision-drivers--optional" title="Direct link to heading">#</a></h2><ul><li>Discover bugs early</li><li>Deliver value from reimplementation quickly</li><li>Minimise mean-time-to-recovery when bugs are discovered</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="considered-options"></a>Considered Options<a class="hash-link" href="#considered-options" title="Direct link to heading">#</a></h2><ol><li>Deploy new CC alongside existing CC in same instance group, using <code>nginx</code> for routing</li><li>Complete an entire endpoint at once (all HTTP methods) and use <code>gorouter</code> for path based routing</li><li>Deploy a dedicated path and HTTP method based router/proxy in front of old and new implementations and split traffic based on that</li></ol><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="decision-outcome"></a>Decision Outcome<a class="hash-link" href="#decision-outcome" title="Direct link to heading">#</a></h2><p>Chosen option: 3 (deploy a path and HTTP method based router/proxy in front of old and new implementations and split traffic based on that),
because it is the only option that allows for separate scaling of old and new implementations as well as routing based on HTTP method and path.
Following images shows a rough routing example with just the verry specific <code>GET /v3/buildpacks/:guid</code> endpoint beeing routed to the go implementation. Everything else will be routed to the cloudcontroller_ng.
<img src="https://user-images.githubusercontent.com/5863788/145360535-a02ebd16-e339-461e-bff5-612b3c4c8f46.png" alt="image"></p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="positive-consequences--optional"></a>Positive Consequences <a class="hash-link" href="#positive-consequences--optional" title="Direct link to heading">#</a></h3><ul><li>New implementation can be built in small units (endpoint + HTTP method)</li><li>Proxy can be registered only for certain routes, minimising throughput</li><li>Networking such as TLS in new implementation can be delayed until closer to completion (as proxy can perform this function)</li><li>Good support for HAProxy BOSH release as it is maintained by SAP team</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="negative-consequences--optional"></a>Negative Consequences <a class="hash-link" href="#negative-consequences--optional" title="Direct link to heading">#</a></h3><ul><li>Additional software to manage</li><li>HAProxy BOSH release is not that well suited to this use case</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="pros-and-cons-of-the-options--optional"></a>Pros and Cons of the Options <a class="hash-link" href="#pros-and-cons-of-the-options--optional" title="Direct link to heading">#</a></h2><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-1-deploy-new-cc-alongside-existing-cc-in-same-instance-group-using-nginx-for-routing"></a>Option 1 (Deploy new CC alongside existing CC in same instance group, using <code>nginx</code> for routing)<a class="hash-link" href="#option-1-deploy-new-cc-alongside-existing-cc-in-same-instance-group-using-nginx-for-routing" title="Direct link to heading">#</a></h3><ul><li>Good, because does not change network architecture</li><li>Good, because does not add any new VMs</li><li>Bad, because cannot independently scale each implementation</li><li>Bad, because would require changes to the CAPI release to support this use case</li></ul><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_31ik" id="option-2-complete-an-entire-endpoint-at-once-all-http-methods-and-use-gorouter-for-path-based-routing"></a>Option 2 (Complete an entire endpoint at once (all HTTP methods) and use <code>gorouter</code> for path based routing)<a class="hash-link" href="#option-2-complete-an-entire-endpoint-at-once-all-http-methods-and-use-gorouter-for-path-based-routing" title="Direct link to heading">#</a></h3><ul><li>Good, because does not change network architecture</li><li>Good, because can independently scale each implementation</li><li>Bad, because requires large amount of work to complete a whole endpoint</li><li>Bad, because requires new implementation to support TLS etc. for secure communication</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_31ik" id="links--optional"></a>Links <a class="hash-link" href="#links--optional" title="Direct link to heading">#</a></h2><ul><li><a href="https://github.com/cloudfoundry-incubator/haproxy-boshrelease" target="_blank" rel="noopener noreferrer">HAProxy BOSH release</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_3kfx"><div class="col"><b>Tags:</b><ul class="tags_2ga9 padding--none margin-left--sm"><li class="tag_11ep"><a class="tag_1Okp tagRegular_3MiF" href="/go-cf-api/adrs/tags/adr">adr</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/cloudfoundry/go-cf-api/edit/main/docs/adrs/2021-08-13-split-traffic-between-both-implementations.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_2_ui" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/go-cf-api/adrs/ADR - Prometheus Framework"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">Â« Use client_golang prometheus library to expose metrics</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/go-cf-api/adrs/ADR - Logging Framework"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Use Zap logging as a performant and customizable structured logging framework Â»</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#context-and-problem-statement" class="table-of-contents__link">Context and Problem Statement</a></li><li><a href="#decision-drivers--optional" class="table-of-contents__link">Decision Drivers  optional </a></li><li><a href="#considered-options" class="table-of-contents__link">Considered Options</a></li><li><a href="#decision-outcome" class="table-of-contents__link">Decision Outcome</a><ul><li><a href="#positive-consequences--optional" class="table-of-contents__link">Positive Consequences  optional </a></li><li><a href="#negative-consequences--optional" class="table-of-contents__link">Negative Consequences  optional </a></li></ul></li><li><a href="#pros-and-cons-of-the-options--optional" class="table-of-contents__link">Pros and Cons of the Options  optional </a><ul><li><a href="#option-1-deploy-new-cc-alongside-existing-cc-in-same-instance-group-using-nginx-for-routing" class="table-of-contents__link">Option 1 (Deploy new CC alongside existing CC in same instance group, using <code>nginx</code> for routing)</a></li><li><a href="#option-2-complete-an-entire-endpoint-at-once-all-http-methods-and-use-gorouter-for-path-based-routing" class="table-of-contents__link">Option 2 (Complete an entire endpoint at once (all HTTP methods) and use <code>gorouter</code> for path based routing)</a></li></ul></li><li><a href="#links--optional" class="table-of-contents__link">Links  optional </a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Documentation</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-cf-api/api">API</a></li><li class="footer__item"><a class="footer__link-item" href="/go-cf-api/docs/intro">Documentation</a></li><li class="footer__item"><a class="footer__link-item" href="/go-cf-api/godocs/intro">GoLang Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/go-cf-api/adrs">Architectural Decision Records</a></li><li class="footer__item"><a href="https://github.com/cloudfoundry/go-cf-api" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_3J9K"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2021-2021 CloudFoundry.org Foundation, Inc. All Rights Reserved.</div></div></div></footer></div>
<script src="/go-cf-api/assets/js/runtime~main.40aa757c.js"></script>
<script src="/go-cf-api/assets/js/main.96fbdae1.js"></script>
</body>
</html>